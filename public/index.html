<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Bullet Hell 60FPS</title>
    <style>
        canvas {
            background: #111;
            display: block;
            margin: auto;
        }
    </style>
</head>

<body>
    <canvas id="game" width="800" height="600"></canvas>
    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        const socket = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`);

        let myId = null;
        let players = [];
        let bullets = [];
        let dummy = {};
        let fullDamageLog = {};
        const damagePopups = [];

        socket.addEventListener('message', e => {
            const data = JSON.parse(e.data);
            if (data.type === 'init') {
                myId = data.id;
                dummy = data.dummy;
            } else if (data.type === 'state') {
                players = data.players;
                bullets = data.bullets;
            } else if (data.type === 'leaderboard') {
                fullDamageLog = data.damageLog;
            } else if (data.type === 'damage') {
                damagePopups.push({
                    x: data.x,
                    y: data.y,
                    amount: data.amount,
                    color: data.color,
                    alpha: 1,
                    dy: -0.5
                });
            }
        });

        document.addEventListener('keydown', e => {
            socket.send(JSON.stringify({ type: 'keydown', key: e.key }));
        });
        document.addEventListener('keyup', e => {
            socket.send(JSON.stringify({ type: 'keyup', key: e.key }));
        });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dummy
            ctx.fillStyle = 'gray';
            ctx.beginPath();
            ctx.arc(dummy.x, dummy.y, dummy.radius, 0, Math.PI * 2);
            ctx.fill();

            // Players
            for (const p of players) {
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
                ctx.fill();
            }

            // Bullets
            for (const b of bullets) {
                ctx.fillStyle = b.color;
                ctx.beginPath();
                ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Damage Popups
            for (let i = damagePopups.length - 1; i >= 0; i--) {
                const d = damagePopups[i];
                ctx.globalAlpha = d.alpha;
                ctx.font = '24px impact';
                ctx.fillStyle = d.color; // shadow color
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 1;
                ctx.fillText(d.amount, d.x, d.y);
                ctx.fillStyle = 'white'; // main dmg number color
                ctx.fillText(d.amount, d.x - 2, d.y - 2);
                ctx.shadowBlur = 0;
                d.y += d.dy * 2;
                d.alpha -= 0.01;
                if (d.alpha <= 0) damagePopups.splice(i, 1);
            }
            ctx.globalAlpha = 1; // Reset alpha

            // Leaderboard
            ctx.font = '2rem calibri ';
            ctx.textAlign = 'left';
            ctx.fillStyle = 'white';
            ctx.fillText('Damage Leaderboard', 10, 35);

            let rankY = 65;
            for (const [id, dmg] of Object.entries(fullDamageLog).sort((a, b) => b[1] - a[1])) {
                const player = players.find(p => p.id === id);
                const color = player?.color || 'white';
                ctx.fillStyle = color;
                ctx.fillText(`${Math.floor(dmg)} dmg`, 10, rankY);
                rankY += 25;
            }

            // Draw self indicator (bottom center)
            const me = players.find(p => p.id === myId);
            if (me) {
                ctx.font = '16px impact';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillStyle = 'white';
                ctx.fillText('You are', canvas.width / 2, canvas.height - 15);

                // Draw a circle in your color
                ctx.beginPath();
                ctx.arc(canvas.width / 2 + 40, canvas.height - 25, 8, 0, Math.PI * 2);
                ctx.fillStyle = me.color;
                ctx.fill();
            }

            requestAnimationFrame(draw);
        }

        requestAnimationFrame(draw);
    </script>
</body>

</html>