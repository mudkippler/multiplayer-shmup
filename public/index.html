<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Bullet Hell Test</title>
    <style>
        canvas {
            background: #111;
            display: block;
            margin: auto;
        }
    </style>
</head>

<body>
    <canvas id="game" width="800" height="600"></canvas>
    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        const socket = new WebSocket(`ws://${location.host}`);
        let myId = null;
        let serverPlayers = [], bullets = [], dummy = {}, myColor = null;
        const interpPlayers = new Map();
        const damagePopups = [];
        const myHits = [];

        let fullDamageLog = {};

        document.addEventListener('keydown', e => {
            socket.send(JSON.stringify({ type: 'keydown', key: e.key }));
        });
        document.addEventListener('keyup', e => {
            socket.send(JSON.stringify({ type: 'keyup', key: e.key }));
        });

        socket.addEventListener('message', e => {
            const data = JSON.parse(e.data);
            if (data.type === 'init') {
                myId = data.id;
                myColor = data.color;
            }
            else if (data.type === 'state') {
                serverPlayers = data.players;
                bullets = data.bullets;
                dummy = data.dummy;
                fullDamageLog = data.damageLog;

                for (let i = 0; i < serverPlayers.length; i++) {
                    const p = serverPlayers[i];
                    const existing = interpPlayers.get(p.id) || { x: p.x, y: p.y };
                    interpPlayers.set(p.id, {
                        prevX: existing.x,
                        prevY: existing.y,
                        x: p.x,
                        y: p.y,
                        color: p.color,
                        id: p.id
                    });
                }
            }
            else if (data.type === 'damage') {
                damagePopups.push({
                    x: data.x,
                    y: data.y,
                    amount: data.amount,
                    color: data.color,
                    alpha: 1,
                    dy: -0.5
                });
            }
        });


        let lastRender = performance.now();
        function draw(now) {
            const delta = (now - lastRender) / (1000 / 30); // relative to tick rate
            lastRender = now;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dummy
            ctx.fillStyle = 'gray';
            ctx.beginPath();
            ctx.arc(dummy.x, dummy.y, dummy.radius, 0, Math.PI * 2);
            ctx.fill();

            // Players (interpolated)
            for (const p of interpPlayers.values()) {
                const ix = p.prevX + (p.x - p.prevX) * delta;
                const iy = p.prevY + (p.y - p.prevY) * delta;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(ix, iy, 10, 0, Math.PI * 2);
                ctx.fill();
                p.prevX = ix; p.prevY = iy;
            }

            // Bullets
            for (const b of bullets) {
                ctx.fillStyle = b.color;
                ctx.beginPath();
                ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Damage popups
            for (let i = damagePopups.length - 1; i >= 0; i--) {
                const d = damagePopups[i];
                ctx.font = '16px sans-serif';
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'white';
                ctx.shadowBlur = 2;
                ctx.fillText(d.amount, d.x, d.y);
                ctx.fillStyle = d.color;
                ctx.fillText(d.amount, d.x - 1, d.y - 1);
                ctx.shadowBlur = 0;
                d.y += d.dy;
                d.alpha -= 0.02;
                if (d.alpha <= 0) damagePopups.splice(i, 1);
            }

            // Total damage
            const total = myHits.reduce((a, b) => a + b, 0);
            ctx.fillStyle = 'white';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(`Total Damage: ${total}`, canvas.width - 10, canvas.height - 10);

            // Draw damage leaderboard (top-left)
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = 'white';
            ctx.fillText('Damage Leaderboard:', 10, 20);

            let rankY = 40;
            for (const [id, dmg] of Object.entries(fullDamageLog).sort((a, b) => b[1] - a[1])) {
                const player = interpPlayers.get(id);
                const color = player?.color || 'white';
                ctx.fillStyle = color;
                ctx.fillText(`${Math.floor(dmg)} dmg`, 10, rankY);
                rankY += 20;
            }

            requestAnimationFrame(draw);
        }
        draw(performance.now());
    </script>
</body>

</html>