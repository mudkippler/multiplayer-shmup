<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bullet Hell 60FPS</title>
  <style>
    canvas { background: #111; display: block; margin: auto; }
  </style>
</head>
<body>
  <canvas id="game" width="800" height="600"></canvas>
  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const socket = new WebSocket(`wss://${location.host}`);
    let myId = null;
    let players = [];
    let bullets = [];
    let dummy = {};
    let fullDamageLog = {};
    const damagePopups = [];

    socket.addEventListener('message', e => {
      const data = JSON.parse(e.data);
      if (data.type === 'init') {
        myId = data.id;
      } else if (data.type === 'state') {
        players = data.players;
        bullets = data.bullets;
        dummy = data.dummy;
        fullDamageLog = data.damageLog;
      } else if (data.type === 'damage') {
        damagePopups.push({
          x: data.x,
          y: data.y,
          amount: data.amount,
          color: data.color,
          alpha: 1,
          dy: -0.5
        });
      }
    });

    document.addEventListener('keydown', e => {
      socket.send(JSON.stringify({ type: 'keydown', key: e.key }));
    });
    document.addEventListener('keyup', e => {
      socket.send(JSON.stringify({ type: 'keyup', key: e.key }));
    });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Dummy
      ctx.fillStyle = 'gray';
      ctx.beginPath();
      ctx.arc(dummy.x, dummy.y, dummy.radius, 0, Math.PI * 2);
      ctx.fill();

      // Players
      for (const p of players) {
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
        ctx.fill();
      }

      // Bullets
      for (const b of bullets) {
        ctx.fillStyle = b.color;
        ctx.beginPath();
        ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
        ctx.fill();
      }

      // Damage Popups
      for (let i = damagePopups.length - 1; i >= 0; i--) {
        const d = damagePopups[i];
        ctx.font = '20px sans-serif';
        ctx.fillStyle = 'white';
        ctx.shadowColor = 'white';
        ctx.shadowBlur = 1;
        ctx.fillText(d.amount, d.x, d.y);
        ctx.fillStyle = d.color;
        ctx.fillText(d.amount, d.x - 1, d.y - 1);
        ctx.shadowBlur = 0;
        d.y += d.dy;
        d.alpha -= 0.02;
        if (d.alpha <= 0) damagePopups.splice(i, 1);
      }

      // Leaderboard
      ctx.font = '2rem calibri';
      ctx.textAlign = 'left';
      ctx.fillStyle = 'white';
      ctx.fillText('Damage Leaderboard:', 10, 25);

      let rankY = 50;
      for (const [id, dmg] of Object.entries(fullDamageLog).sort((a, b) => b[1] - a[1])) {
        const player = players.find(p => p.id === id);
        const color = player?.color || 'white';
        ctx.fillStyle = color;
        ctx.fillText(`${Math.floor(dmg)} dmg`, 10, rankY);
        rankY += 25;
      }

      requestAnimationFrame(draw);
    }

    requestAnimationFrame(draw);
  </script>
</body>
</html>
