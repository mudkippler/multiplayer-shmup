<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Bullet Hell Test</title>
    <style>
        canvas {
            background: #111;
            display: block;
            margin: auto;
        }
    </style>
</head>

<body>
    <canvas id="game" width="800" height="600"></canvas>
    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        const socket = new WebSocket(`ws://${location.host}`);
        let myId = null;
        let serverPlayers = [], bullets = [], dummy = {}, myColor = null;
        //const interpPlayers = new Map();
        const snapshots = []; // Array of { time: ms, players: Map<id, {x, y, color}> }
        const SNAPSHOT_DELAY = 100; // ms
        const MAX_SNAPSHOTS = 60;   // Just in case


        const damagePopups = [];
        const myHits = [];

        let fullDamageLog = {};

        document.addEventListener('keydown', e => {
            socket.send(JSON.stringify({ type: 'keydown', key: e.key }));
        });
        document.addEventListener('keyup', e => {
            socket.send(JSON.stringify({ type: 'keyup', key: e.key }));
        });

        socket.addEventListener('message', e => {
            const data = JSON.parse(e.data);
            if (data.type === 'init') {
                myId = data.id;
                myColor = data.color;
            }
            else if (data.type === 'state') {
                dummy = data.dummy;
                bullets = data.bullets;
                fullDamageLog = data.damageLog;

                const snapTime = performance.now();
                const playerMap = new Map();

                for (const p of data.players) {
                    playerMap.set(p.id, { x: p.x, y: p.y, color: p.color });
                }

                snapshots.push({ time: snapTime, players: playerMap });
                if (snapshots.length > MAX_SNAPSHOTS) snapshots.shift();
            }
            else if (data.type === 'damage') {
                damagePopups.push({
                    x: data.x,
                    y: data.y,
                    amount: data.amount,
                    color: data.color,
                    alpha: 1,
                    dy: -0.5
                });
            }
        });


        let lastRender = performance.now();
        function draw(now) {
            lastRender = now;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dummy
            ctx.fillStyle = 'gray';
            ctx.beginPath();
            ctx.arc(dummy.x, dummy.y, dummy.radius, 0, Math.PI * 2);
            ctx.fill();

            // Players with interpolation from snapshot history
            const renderTime = now - SNAPSHOT_DELAY;

            // Find the two snapshots to interpolate between
            let older, newer;
            for (let i = snapshots.length - 1; i >= 0; i--) {
                if (snapshots[i].time <= renderTime) {
                    older = snapshots[i];
                    newer = snapshots[i + 1];
                    break;
                }
            }

            if (older && newer) {
                const t = (renderTime - older.time) / (newer.time - older.time);
                for (const [id, pOld] of older.players) {
                    const pNew = newer.players.get(id);
                    if (!pNew) continue;

                    const ix = pOld.x + (pNew.x - pOld.x) * t;
                    const iy = pOld.y + (pNew.y - pOld.y) * t;
                    ctx.fillStyle = pOld.color;
                    ctx.beginPath();
                    ctx.arc(ix, iy, 10, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Bullets
            for (const b of bullets) {
                ctx.fillStyle = b.color;
                ctx.beginPath();
                ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Damage popups
            for (let i = damagePopups.length - 1; i >= 0; i--) {
                const d = damagePopups[i];
                ctx.font = '16px sans-serif';
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'white';
                ctx.shadowBlur = 2;
                ctx.fillText(d.amount, d.x, d.y);
                ctx.fillStyle = d.color;
                ctx.fillText(d.amount, d.x - 1, d.y - 1);
                ctx.shadowBlur = 0;
                d.y += d.dy;
                d.alpha -= 0.02;
                if (d.alpha <= 0) damagePopups.splice(i, 1);
            }

            // Total damage
            const total = myHits.reduce((a, b) => a + b, 0);
            ctx.fillStyle = 'white';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(`Total Damage: ${total}`, canvas.width - 10, canvas.height - 10);

            // Draw damage leaderboard (top-left)
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = 'white';
            ctx.fillText('Damage Leaderboard:', 10, 20);

            let rankY = 40;
            const latestSnapshot = snapshots.at(-1)?.players;

            for (const [id, dmg] of Object.entries(fullDamageLog).sort((a, b) => b[1] - a[1])) {
                const color = latestSnapshot?.get(id)?.color || 'white';
                ctx.fillStyle = color;
                ctx.fillText(`${Math.floor(dmg)} dmg`, 10, rankY);
                rankY += 20;
            }

            requestAnimationFrame(draw);
        }
        draw(performance.now());
    </script>
</body>

</html>